df_vol_index
df_index_comparison <-
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate) %>%
left_join(
df_chain_desc %>%
select(expiration, execution, realized_vol, return)
, by = "expiration"
) %>%
filter(trade_date == execution) %>%
left_join(
df_vol_index %>%
mutate(vol_index = price / 100) %>%
select(date, vol_index)
, by = c("trade_date" = "date")
)
df_index_comparison <-
df_index_comparison %>%
mutate(vol_diff = bid_swap_rate - vol_index)
df_index_comparison %>%
filter(abs(vol_diff) > 0.05)
df_index_comparison %>%
filter(abs(vol_diff) > 0.05)
source('~/files/ods/weekly_option/script/02_wrangler_trade_pnl.R', echo=TRUE)
write_csv(df_pnl, "spy_weekly_2014_2018_pnl_master_NEW.csv")
write_csv(df_trade, "spy_weekly_2014_2018_trade_master_NEW.csv")
######################
## loading packages ##
######################
library(tidyverse)
library(lubridate)
library(tidyquant)
library(bizdays)
# initializing bizdays libraries
load_rmetrics_calendars(2000:2020)
bizdays.options$set(default.calendar="Rmetrics/NYSE")
#####################
## reading in data ##
#####################
df_chain_desc <-
read_csv("data_output/spy_weekly_2014_2018_chain_desc_NEW.csv")
df_chain_hist <-
read_csv("data_output/spy_weekly_2014_2018_chain_hist_NEW.csv")
df_opt_hist <-
read_csv("data_output/spy_weekly_2014_2018_opt_hist_NEW.csv")
df_pnl <-
read_csv("data_output/spy_weekly_2014_2018_pnl_master_NEW.csv")
df_pnl <-
read_csv("data_output/spy_weekly_2014_2018_trade_master_NEW.csv")
df_chain_desc <-
read_csv("data_output/spy_weekly_2014_2018_chain_desc_NEW.csv")
df_chain_hist <-
read_csv("data_output/spy_weekly_2014_2018_chain_hist_NEW.csv")
df_opt_hist <-
read_csv("data_output/spy_weekly_2014_2018_opt_hist_NEW.csv")
df_pnl <-
read_csv("data_output/spy_weekly_2014_2018_pnl_master_NEW.csv")
df_trade <-
read_csv("data_output/spy_weekly_2014_2018_trade_master_NEW.csv")
View(df_trade)
df_pnl
View(df_pnl)
###########################################################
## check that dh pnls match up with realized vol premium ##
###########################################################
df_pnl %>%
filter(variation == 0.1)
%>%
df_pnl %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
pnl = sum(dly_tot_pnl)
)
###########################################################
## check that dh pnls match up with realized vol premium ##
###########################################################
# premium by expiration
df_trade %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
premium = sum(bid)
)
###########################################################
## check that dh pnls match up with realized vol premium ##
###########################################################
# premium by expiration
df_prem_exp <-
df_trade %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
premium = sum(bid)
)
# pnl by expiration
df_pnl_exp <-
df_pnl %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
pnl = sum(dly_tot_pnl)
)
df_pnl_exp %>%
df_chain_desc
df_pnl_exp %>%
df_chain_desc
######################
## loading packages ##
######################
library(tidyverse)
library(lubridate)
library(tidyquant)
library(bizdays)
# initializing bizdays libraries
load_rmetrics_calendars(2000:2020)
bizdays.options$set(default.calendar="Rmetrics/NYSE")
#####################
## reading in data ##
#####################
df_chain_desc <-
read_csv("data_output/spy_weekly_2014_2018_chain_desc_NEW.csv")
df_chain_hist <-
read_csv("data_output/spy_weekly_2014_2018_chain_hist_NEW.csv")
df_opt_hist <-
read_csv("data_output/spy_weekly_2014_2018_opt_hist_NEW.csv")
df_pnl <-
read_csv("data_output/spy_weekly_2014_2018_pnl_master_NEW.csv")
df_trade <-
read_csv("data_output/spy_weekly_2014_2018_trade_master_NEW.csv")
df_chain_desc
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
)
df_chain_desc
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol)
View(df_chain_hist)
df_chain_hist
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = "underlying", "expiration"
)
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
)
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
fitler(trade_date == execution)
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution)
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate)
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
) %>%
left_join(
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate)
, by = c("underlying", "expiration")
)
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
) %>%
left_join(
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate)
, by = c("underlying_symbol"="underlying", "expiration")
)
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
)
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration
, trade_date, bid_swap_rate
)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate)
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration
, trade_date, bid_swap_rate
)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate)
df_vol_prem <-
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration
, trade_date, bid_swap_rate
)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate) %>%
mutate(
vol_prem = bid_swap_rate - realized_vol
)
df_vol_prem <-
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate) %>%
mutate(
vol_prem = bid_swap_rate - realized_vol
)
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underling_symbol" = "underlying", "expiration")
)
# premium recieved and dh pnl for each expiration
df_prem_vs_pnl <-
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
)
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underling_symbol" = "underlying", "expiration")
)
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underlying_symbol" = "underlying", "expiration")
)
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underlying_symbol" = "underlying", "expiration")
)
df_report <-
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underlying_symbol" = "underlying", "expiration")
) %>%
mutate(
pnl_ratio = pnl / premium
)
df_report
df_report %>%
ggplot() +
geom_point(aes(x = vol_prem, y = pnl_ratio))
# premium by expiration
df_prem_exp <-
df_trade %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
premium = sum(bid)
)
# pnl by expiration
df_pnl_exp <-
df_pnl %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
pnl = sum(dly_opt_pnl)
)
# premium recieved and dh pnl for each expiration
df_prem_vs_pnl <-
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
)
df_vol_prem <-
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate) %>%
mutate(
vol_prem = bid_swap_rate - realized_vol
)
df_report <-
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underlying_symbol" = "underlying", "expiration")
) %>%
mutate(
pnl_ratio = pnl / premium
)
df_report %>%
ggplot() +
geom_point(aes(x = vol_prem, y = pnl_ratio))
# premium by expiration
df_prem_exp <-
df_trade %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
premium = sum(bid)
)
# pnl by expiration
df_pnl_exp <-
df_pnl %>%
filter(variation == 0.1) %>%
group_by(
underlying_symbol
, expiration
) %>%
summarize(
pnl = sum(dly_tot_pnl)
)
# premium recieved and dh pnl for each expiration
df_prem_vs_pnl <-
df_prem_exp %>%
left_join(
df_pnl_exp
, by = c("underlying_symbol", "expiration")
)
df_vol_prem <-
df_chain_desc %>%
select(underlying, expiration, execution, realized_vol) %>%
left_join(
df_chain_hist %>%
select(underlying, expiration, trade_date, bid_swap_rate)
, by = c("underlying", "expiration")
) %>%
filter(trade_date == execution) %>%
select(underlying, expiration, realized_vol, bid_swap_rate) %>%
mutate(
vol_prem = bid_swap_rate - realized_vol
)
df_report <-
df_prem_vs_pnl %>%
left_join(
df_vol_prem
, by = c("underlying_symbol" = "underlying", "expiration")
) %>%
mutate(
pnl_ratio = pnl / premium
)
df_report %>%
ggplot() +
geom_point(aes(x = vol_prem, y = pnl_ratio))
# directionally correct cases
df_report %>%
filter(
(vol_prem > 0 & pnl_ratio > 0) |
(vol_prem < 0 & pnl_ratio < 0)
)
206 /260
df_report %>%
filter(vol_prem > 0 & pnl_ratio < 0)
#
df_report %>%
filter(vol_prem > 0 & pnl_ratio < 0) %>%
arrange(pnl_ratio)
# should have been losers but they were winners
df_report %>%
filter(vol_prem < 0 & pnl_ratio > 0) %>%
arrange(desc(pnl_ratio))
# should have been losers but they were winners
df_report %>%
filter(vol_prem < 0 & pnl_ratio > 0) %>%
arrange(desc(pnl_ratio))
df_report %>%
filter(vol_prem < 0 & pnl_ratio > 0) %>%
arrange(desc(pnl_ratio))
df_report %>%
filter(vol_prem < 0 & pnl_ratio > 0) %>%
arrange(desc(pnl_ratio))
df_report %>%
filter(vol_prem > 0 & pnl_ratio < 0) %>%
arrange(pnl_ratio)
df_report %>%
filter(vol_prem > 0 & pnl_ratio < 0) %>%
arrange(pnl_ratio)
df_pnl %>%
filter(variation = 0.1) %>%
filter(expiration == "2018-01-05")
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05")
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05")
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
View()
df_report %>%
filter(vol_prem > 0 & pnl_ratio < 0) %>%
arrange(pnl_ratio)
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
View()
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
filter(type = "call")
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
filter(type == "call")
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
filter(type == "call") %>%
select(underlying_price)
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
filter(type == "call") %>%
select(underlying_price) %>%
mutate(
ret = log(underlying_price) - log(lag(underlying_price))
)
df_pnl %>%
filter(variation == 0.1) %>%
filter(expiration == "2018-01-05") %>%
filter(type == "call") %>%
select(underlying_price) %>%
mutate(
ret = log(underlying_price) - log(lag(underlying_price))
) %>%
.$ret %>% sd(na.rm = TRUE) * sqrt(252)
